# 管理画面ログイン 401エラー解決手順

## 現在の問題

初期管理者ユーザーを作成した後でも、ログイン時に401エラーが発生する。

## 原因の確認

401エラーが続く場合、以下の原因が考えられます：

1. **PASSWORD_PEPPER環境変数が設定されていない、または異なる値になっている**
2. **初期管理者ユーザーの作成が失敗している**
3. **メールアドレスやパスワードが間違っている**

## 解決手順

### ステップ1: Railwayの環境変数を確認

Railwayダッシュボードで以下の環境変数が設定されているか確認してください：

1. Railwayダッシュボードにアクセス
2. バックエンドサービスを選択
3. 「Variables」タブを開く
4. 以下の環境変数を確認：
   - `PASSWORD_PEPPER` - **必須**（パスワードのハッシュ化に使用）
   - `JWT_SECRET` - **必須**（JWTトークンの生成に使用）
   - `JWT_EXPIRES_IN` - オプション（デフォルト: 24h）

**重要**: `PASSWORD_PEPPER`が設定されていない場合、パスワードの検証が失敗します。

### ステップ2: 初期管理者ユーザーの作成を再試行

以下のコマンドで初期管理者ユーザーを作成してください：

```bash
curl -X POST https://idobata-backend-production.up.railway.app/api/auth/initialize \
  -H "Content-Type: application/json" \
  -d '{
    "name": "管理者",
    "email": "admin@example.com",
    "password": "Admin123!@#"
  }'
```

**レスポンスを確認**:
- **成功**: `{"message": "初期管理者ユーザーが正常に作成されました", "user": {...}}`
- **既に存在**: `{"message": "管理者ユーザーは既に初期化されています"}`

### ステップ3: Railwayのログを確認

Railwayのログでエラーメッセージを確認してください：

1. Railwayダッシュボードにアクセス
2. バックエンドサービスを選択
3. 「Logs」タブを開く
4. ログイン試行時のエラーメッセージを確認

以下のようなエラーメッセージを探してください：
- `[AuthController] Authentication error:`
- `[AuthController] Login error:`
- `ユーザーが見つかりません`
- `パスワードが正しくありません`

### ステップ4: PASSWORD_PEPPERを設定/確認

`PASSWORD_PEPPER`が設定されていない場合、設定してください：

1. Railwayダッシュボードで「Variables」タブを開く
2. 「New Variable」をクリック
3. 以下を入力：
   - **Name**: `PASSWORD_PEPPER`
   - **Value**: ランダムな文字列（例: `your-secret-pepper-value-here`）
4. 「Add」をクリック

**注意**: 
- `PASSWORD_PEPPER`を変更すると、既存のパスワードでログインできなくなります
- 既存の`PASSWORD_PEPPER`がある場合は、その値を使用してください
- 新しい`PASSWORD_PEPPER`を設定した場合は、初期管理者ユーザーを再作成する必要があります

### ステップ5: 初期管理者ユーザーを再作成

`PASSWORD_PEPPER`を新しく設定した場合、初期管理者ユーザーを再作成してください：

1. 既存の管理者ユーザーを削除（MongoDBに直接アクセスするか、管理者ユーザーが存在しないことを確認）
2. 初期管理者ユーザーを作成するコマンドを再実行

### ステップ6: ログインを再試行

1. 管理画面にアクセス: `https://idobata-admin-336788531163.asia-northeast1.run.app`
2. 作成したメールアドレスとパスワードを入力
3. 「ログイン」ボタンをクリック

## トラブルシューティング

### エラー: "管理者ユーザーは既に初期化されています"

既存の管理者ユーザーが存在する場合、そのメールアドレスとパスワードを使用してください。

**解決方法**:
1. Railwayのログを確認して、既存の管理者ユーザーのメールアドレスを確認
2. そのメールアドレスとパスワードでログインを試す
3. パスワードを忘れた場合、MongoDBに直接アクセスしてパスワードをリセットするか、新しい管理者ユーザーを作成する

### エラー: "認証に失敗しました"

このエラーは、メールアドレスまたはパスワードが間違っているか、`PASSWORD_PEPPER`環境変数が正しく設定されていないことを示しています。

**解決方法**:
1. `PASSWORD_PEPPER`環境変数が設定されているか確認
2. メールアドレスとパスワードが正しいか確認
3. パスワードに特殊文字が含まれている場合、正しく入力されているか確認
4. Railwayのログで詳細なエラーメッセージを確認

### エラー: "ユーザーが見つかりません"

このエラーは、指定されたメールアドレスの管理者ユーザーが存在しないことを示しています。

**解決方法**:
1. 初期管理者ユーザーを作成するコマンドを実行
2. メールアドレスが正しいか確認（大文字小文字を区別する）

### エラー: "パスワードが正しくありません"

このエラーは、パスワードが間違っているか、`PASSWORD_PEPPER`環境変数が異なる値を示しています。

**解決方法**:
1. パスワードが正しいか確認
2. `PASSWORD_PEPPER`環境変数が正しく設定されているか確認
3. `PASSWORD_PEPPER`を変更した場合、初期管理者ユーザーを再作成する必要があります

## 確認事項チェックリスト

- [ ] Railwayの`PASSWORD_PEPPER`環境変数が設定されている
- [ ] Railwayの`JWT_SECRET`環境変数が設定されている
- [ ] 初期管理者ユーザーを作成した
- [ ] 作成時のレスポンスで成功メッセージが返ってきた
- [ ] メールアドレスとパスワードが正しい
- [ ] Railwayのログでエラーメッセージを確認した

## 次のステップ

1. 上記の手順に従って、`PASSWORD_PEPPER`環境変数を確認・設定
2. 初期管理者ユーザーを作成
3. ログインを再試行
4. まだエラーが発生する場合は、Railwayのログで詳細なエラーメッセージを確認
