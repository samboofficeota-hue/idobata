# フロントエンド修正方針

## 1. 現状の問題点

### バックエンドで生成されるデータ構造
- **論点まとめ（DebateAnalysis）**: `questionId`, `questionText`, `axes`, `agreementPoints`, `disagreementPoints`
- **意見まとめ（DigestDraft）**: `questionId`, `title`, `content`
- **イラスト要約（QuestionVisualReport）**: `questionId`, `overallAnalysis` (HTML文字列)

### フロントエンドで期待するデータ構造
- **論点まとめ**: `axes`, `agreementPoints`, `disagreementPoints` (null許可)
- **意見まとめ**: `title`, `content` (null許可)
- **イラスト要約**: HTML文字列 (null許可)

### 問題点
1. **データ構造の不一致**: バックエンドから返されるデータ構造と、フロントエンドが期待する構造が完全に一致していない可能性
2. **nullチェックの不備**: データが存在しない場合の処理が不十分
3. **データ変換の不備**: バックエンドのMongooseドキュメントを適切な形式に変換していない

## 2. 修正方針

### 2.1 バックエンドAPIの修正（完了済み）

**修正内容:**
- `getQuestionDetails`で`debateData`を取得する際、フロントエンドが期待する形式に変換
- `getDebateAnalysis`に`.lean()`を追加してオブジェクトとして返す

**修正箇所:**
- `idea-discussion/backend/controllers/questionController.js` (184行目付近)
- `idea-discussion/backend/services/debateAnalysisGenerator.js` (9-13行目)

### 2.2 フロントエンドの型定義の修正（完了済み）

**修正内容:**
- `debateData`の型定義に`| null`を追加

**修正箇所:**
- `frontend/src/hooks/useQuestionDetail.ts` (9-19行目)

### 2.3 フロントエンドの表示コンポーネントの確認と修正

#### 2.3.1 論点まとめ（DebatePointsContent）

**現状:**
- `debateData`が`null`の場合、「論点データを読み込み中...」と表示
- `axes`, `agreementPoints`, `disagreementPoints`を表示

**確認事項:**
- バックエンドから返されるデータ構造が正しく表示されるか
- データが存在しない場合のメッセージが適切か

**修正方針:**
- データが存在しない場合のメッセージを「論点まとめはまだ生成されていません」に変更
- データ構造の確認と、必要に応じて表示ロジックの調整

#### 2.3.2 意見まとめ（OpinionSummaryContent）

**現状:**
- `digestDraft`が`null`の場合、適切なメッセージを表示
- `title`と`content`を表示

**確認事項:**
- バックエンドから返されるデータ構造が正しく表示されるか
- Markdownレンダリングが正しく動作するか

**修正方針:**
- データ構造の確認と、必要に応じて表示ロジックの調整

#### 2.3.3 イラスト要約（IllustrationSummaryContent）

**現状:**
- `visualReport`（HTML文字列）をiframeで表示

**確認事項:**
- バックエンドから返されるHTMLが正しく表示されるか
- データが存在しない場合の処理が適切か

**修正方針:**
- データ構造の確認と、必要に応じて表示ロジックの調整

### 2.4 質問詳細ページ（QuestionDetail）の確認

**確認事項:**
- 各レポートセクションで、対応する「シャープな問い」の情報が明確に表示されているか
- データが存在しない場合の空状態表示が適切か

**修正方針:**
- 各レポートセクションに、対応する質問の情報（`tagLine`または`questionText`）を表示
- 空状態のメッセージを統一

## 3. 修正の優先順位

### 優先度: 高
1. ✅ バックエンドAPIのデータ変換（完了）
2. ✅ フロントエンドの型定義修正（完了）
3. ⏳ 論点まとめの表示確認と修正
4. ⏳ 意見まとめの表示確認と修正
5. ⏳ イラスト要約の表示確認と修正

### 優先度: 中
6. ⏳ 質問詳細ページでの関連性の明確化
7. ⏳ 空状態メッセージの統一

## 4. 確認すべきポイント

### 4.1 データの流れ
```
バックエンド
  ↓
DebateAnalysis.findOne() → debateData
  ↓
getQuestionDetails() → debateDataを変換
  ↓
フロントエンド
  ↓
useQuestionDetail() → questionDetail.debateData
  ↓
DebatePointsContent → 表示
```

### 4.2 データ構造の確認
- バックエンドから返される`debateData`の構造
- フロントエンドが期待する構造
- 変換処理が正しく動作しているか

### 4.3 エラーハンドリング
- データが存在しない場合の処理
- データ構造が期待と異なる場合の処理
- ネットワークエラーなどの例外処理

## 5. 次のステップ

1. **バックエンドAPIのレスポンスを確認**
   - 実際に返されるデータ構造を確認
   - 必要に応じて変換処理を調整

2. **フロントエンドの表示を確認**
   - 各コンポーネントでデータが正しく表示されるか確認
   - 必要に応じて表示ロジックを調整

3. **統合テスト**
   - バックエンドとフロントエンドを連携させて動作確認
   - エッジケース（データが存在しない場合など）のテスト
