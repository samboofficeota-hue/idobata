# 意見まとめが表示されない原因分析

## 問題の状況
- フロントエンドの「意見まとめ」コラムに何も表示されない

## 原因の可能性

### 1. DigestDraftが生成されていない（最も可能性が高い）

**生成の前提条件:**
- `DigestDraft`を生成するには、**まず`PolicyDraft`が存在する必要がある**
- `generateDigestDraft`関数（`workers/digestGenerator.js`）の68-79行目を見ると：

```javascript
const latestPolicyDraft = await PolicyDraft.findOne({
  questionId: questionId,
})
  .sort({ createdAt: -1 })
  .limit(1);

if (!latestPolicyDraft) {
  console.error(
    `[DigestGenerator] No policy draft found for questionId: ${questionId}`
  );
  return; // ここで処理が終了
}
```

**つまり:**
- 管理画面で「市民意見レポート」の「更新する」ボタンを押しても
- `PolicyDraft`が存在しない場合は、`DigestDraft`は生成されない
- その結果、データベースに`DigestDraft`が存在しない
- フロントエンドで`digestDraft`が`null`になり、空状態が表示される

### 2. questionIdの型不一致

**現在の実装:**
- `getQuestionDetails`（176-180行目）:
  ```javascript
  const digestDraft = await DigestDraft.findOne({
    questionId: new mongoose.Types.ObjectId(questionId),
  })
  ```

- `generateDigestDraft`（158行目）:
  ```javascript
  const newDraft = new DigestDraft({
    questionId: questionId, // 文字列のまま保存される可能性
    ...
  });
  ```

**問題点:**
- Mongooseは通常、文字列を自動的に`ObjectId`に変換しますが
- 検索時に明示的に`ObjectId`に変換している一方、保存時は文字列のままの場合
- 型が一致せず、検索で見つからない可能性がある

### 3. データ取得のタイミング

**現在の実装:**
- `getQuestionDetails`は既存の`DigestDraft`を取得するだけ
- 生成処理は別のエンドポイント（`POST /api/themes/:themeId/questions/:questionId/generate-digest`）で実行される
- 生成が非同期で実行される場合、生成完了前にページを表示するとデータが存在しない

### 4. フロントエンドの表示ロジック

**現在の実装:**
- `ReportCard`の`isEmpty`プロパティ: `!questionDetail?.digestDraft`
- `digestDraft`が`null`または`undefined`の場合、空状態が表示される
- `OpinionSummaryContent`でも`digestDraft`が`null`の場合、メッセージを表示

**問題点:**
- データが存在しない場合、適切なメッセージが表示されるはず
- しかし「何も表示されない」ということは、`isEmpty`が`false`になっている可能性がある
- または、`digestDraft`が空のオブジェクト`{}`になっている可能性

## 確認すべきポイント

### 1. データベースの確認
```javascript
// MongoDBで直接確認
db.digestdrafts.find({ questionId: ObjectId("...") })
```

### 2. バックエンドのログ確認
- `generateDigestDraft`の実行ログ
- `PolicyDraft`が存在するかどうかのログ
- `DigestDraft`の保存成功ログ

### 3. フロントエンドのデバッグ
```javascript
// QuestionDetail.tsxで確認
console.log('digestDraft:', questionDetail?.digestDraft);
console.log('isEmpty:', !questionDetail?.digestDraft);
```

### 4. APIレスポンスの確認
- ブラウザの開発者ツールで`/api/themes/:themeId/questions/:questionId/details`のレスポンスを確認
- `digestDraft`フィールドの値

## 最も可能性が高い原因

**`PolicyDraft`が存在しないため、`DigestDraft`が生成されていない**

**確認方法:**
1. 管理画面で「市民意見レポート」の「更新する」ボタンを押す
2. バックエンドのログで「No policy draft found」というエラーが出ていないか確認
3. もし出ている場合、まず`PolicyDraft`を生成する必要がある

**解決策:**
1. `PolicyDraft`を先に生成する
2. その後、`DigestDraft`を生成する
3. または、`DigestDraft`の生成時に`PolicyDraft`が存在しない場合の処理を追加

## その他の可能性

### データ構造の不一致
- バックエンドから返される`digestDraft`の構造と、フロントエンドが期待する構造が一致していない
- 現在の実装では、`title`, `content`, `createdAt`のみを返している（245-250行目）
- これは正しいので、この可能性は低い

### キャッシュの問題
- ブラウザのキャッシュや、APIのキャッシュが古いデータを返している
- ページをリロードしても解決しない場合は、この可能性がある
