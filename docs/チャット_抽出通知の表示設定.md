# チャット「課題・解決策が登録されました」表示の設定箇所

対話中に薄いグレーで表示される「〇〇という課題が登録されました」「〇〇という解決策が登録されました」は、**バックエンドの抽出（extraction）完了通知**をチャット履歴に載せているためです。

**対応済み**: チャットに追加しないよう、ThemeDetailChatManager と QuestionChatManager の `handleNewExtraction` で `onNewMessage` を呼ばないように変更済み（抽出イベントは `onNewExtraction` のみ呼び出し）。

---

## 1. メッセージをチャットに追加している箇所（発生元）

抽出が完了すると WebSocket の `new-extraction` が飛び、ここで **SystemNotification が作成され、チャットに 1 件追加**されています。

### テーマ単位チャット（お題詳細）

| ファイル | 行付近 | 内容 |
|----------|--------|------|
| **frontend/src/services/chatManagers/ThemeDetailChatManager.ts** | **210-231** | `handleNewExtraction`: `new-extraction` 受信時に `「${data.statement}」という課題が登録されました。` / `という解決策が登録されました。` の文言で `SystemNotification` を作成し、`this.onNewMessage?.(notification)` でチャットに追加している。 |

### 問い単位チャット（問い詳細）

| ファイル | 行付近 | 内容 |
|----------|--------|------|
| **frontend/src/services/chatManagers/QuestionChatManager.ts** | **165-188** | 上記と同様に `handleNewExtraction` で同じ文言の `SystemNotification` を作成し、`this.onNewMessage?.(notification)` でチャットに追加している。 |

**ユーザーに表示しないようにする場合の候補:**
- 上記 2 ファイルの `handleNewExtraction` 内で、`this.onNewMessage?.(notification)` の呼び出しをやめる（通知は `this.onNewExtraction?.(event)` のみにし、ページの抽出リスト更新などだけに使う）。

---

## 2. 表示スタイル（薄いグレー・中央寄せ）を指定している箇所

「system-message」として渡されたメッセージは `SystemNotification` として描画され、**薄いグレー・中央寄せ**のスタイルが当たっています。

| ファイル | 行付近 | 内容 |
|----------|--------|------|
| **frontend/src/components/chat/common/ExtendedChatHistory.tsx** | **37, 45, 54-55** | `msg instanceof SystemNotification` のとき、`flex justify-center`（中央寄せ）と `bg-gray-100 border border-gray-200 text-gray-700 rounded-2xl`（薄いグレー背景・枠・文字色）を指定している。 |

表示自体をやめる場合は「1」でチャットに追加しないようにするのが適切です。スタイルだけ変える場合はここを編集します。

---

## 3. 「system-message」として扱っている箇所

チャット UI は `MessageType === "system-message"` を `SystemNotification` に変換し、ExtendedChatHistory が上記スタイルで描画します。

| ファイル | 行付近 | 内容 |
|----------|--------|------|
| **frontend/src/pages/ThemeDetail.tsx** | **61-75** | `handleNewMessage`: `message instanceof SystemNotification` なら `messageType = "system-message"` とし、`floatingChatRef.current.addMessage(message.content, messageType, options)` で渡している。 |
| **frontend/src/pages/QuestionDetail.tsx** | **53-60** | 同様に `message.constructor.name === "SystemNotification"` のとき `messageType = "system-message"` で `addMessage` している。 |
| **frontend/src/components/chat/common/ChatProvider.tsx** | **62-63, 139-140** | `addMessage` で `type === "system-message"` のとき `new SystemNotification(...)` を作成して messages に追加している。 |

---

## 4. データの流れ（要約）

1. バックエンド: チャット送信後に非同期で抽出 → WebSocket で `new-extraction` を送信。
2. **ThemeDetailChatManager** / **QuestionChatManager** の `handleNewExtraction` がイベントを受信し、**「〇〇という課題が登録されました」等の SystemNotification を生成して onNewMessage で渡す。**
3. ThemeDetail / QuestionDetail の `handleNewMessage` が `system-message` として FloatingChat の `addMessage` を呼ぶ。
4. ChatProvider が `SystemNotification` として messages に追加。
5. **ExtendedChatHistory** が `SystemNotification` を薄いグレー・中央寄せで表示。

---

## 5. 非表示にする変更案（参考）

ユーザーにバックエンド処理の通知を見せないようにするには、**1** の「チャットに追加する処理」をやめます。

- **ThemeDetailChatManager.ts** の `handleNewExtraction` 内: `this.messages.push(notification)` と `this.onNewMessage?.(notification)` を削除またはコメントアウトする。`this.onNewExtraction?.(event)` は残す（他コンポーネントで抽出リスト更新に使う場合）。
- **QuestionChatManager.ts** の `handleNewExtraction` 内: 同様に `this.messages.push(notification)` と `this.onNewMessage?.(notification)` を削除またはコメントアウトする。

これでチャット履歴には「課題が登録されました」等の行は出ず、抽出結果の更新だけが必要なら `onNewExtraction` 経由で従来どおり行えます。
