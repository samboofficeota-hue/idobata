# 論点レポート（みんなの論点）のデータソース説明

## 論点レポートは「どの変数」を読んでいるか

**読んでいる変数: `debateData.formattedReport`**（およびフォールバックで `debateData.axes` / `agreementPoints` / `disagreementPoints`）

### フロントエンド

- **QuestionDetail ページ**  
  `questionDetail?.debateData` を **DebatePointsContent** に渡している。
- **DebatePointsContent**（`frontend/src/components/question/DebatePointsContent.tsx`）  
  - `debateData.formattedReport` が存在し、かつ HTML 文字列（`<!DOCTYPE html>` または `<html` を含む）の場合  
    → **その HTML を iframe で表示**（＝「論点レポート」の AI まとめ部分）。
  - そうでない場合  
    → `debateData.axes` / `agreementPoints` / `disagreementPoints` を構造表示。

### バックエンド（問い詳細 API）

- **GET `/api/themes/:themeId/questions/:questionId/details`**  
  - `debateData` は **DebateAnalysis** から取得（`getDebateAnalysisFromService(questionId)`）。
  - 返却しているのは **DebateAnalysis ドキュメント**の:
  - `axes`
  - `agreementPoints`
  - `disagreementPoints`
  - **`formattedReport`**（HTML 文字列）

つまり、画面上の「論点レポート」の AI まとめは、**常に `debateData.formattedReport` を表示している**設定になっています。

---

## このページ用に AI が「独自に」回答を作っているか

**はい。論点レポート用のまとめは、この問い専用に 2 段階で生成されています。**

### 論点レポートの生成フロー（`idea-discussion/backend/services/debateAnalysisGenerator.js`）

1. **入力**  
   この問い（questionId）に紐づく **Problem / Solution**（QuestionLink 経由）のテキストのみを集める。

2. **1 回目の LLM**  
   - 上記の「課題・解決策」テキストだけを入力に、**論点分析プロンプト**で JSON を生成。
   - 出力: `axes`（主要な論点と対立軸）、`agreementPoints`（合意点）、`disagreementPoints`（対立点）。

3. **2 回目の LLM**  
   - その JSON だけを入力に、**論点レポート HTML 生成プロンプト**で「読みやすい HTML レポート」を生成。
   - この結果が **`formattedReport`** として保存される。

4. **保存**  
   DebateAnalysis に  
   `axes`, `agreementPoints`, `disagreementPoints`, **formattedReport** を保存。

したがって、

- 論点レポートの AI まとめは、**この問いの論点データだけ**を元にした **このページ用の独自生成**です。
- イラストまとめ（`visualReport` / `overallAnalysis`）や、市民意見レポート（`digestDraft`）の変数は使っておらず、**`formattedReport` 専用のパイプライン**です。

---

## 他レポートとの違い（変数・API の対応）

| 表示名 | フロントで参照している変数 | API で返している中身 | 生成元 |
|--------|---------------------------|------------------------|--------|
| **みんなの論点（論点レポート）** | `questionDetail.debateData`（特に `formattedReport`） | DebateAnalysis の `axes` / `agreementPoints` / `disagreementPoints` / **formattedReport** | debateAnalysisGenerator.js（2 段階 LLM） |
| イラストまとめ | `questionDetail.visualReport` | `visualReport.overallAnalysis` | questionVisualReportGenerator.js |
| 市民意見レポート（意見まとめ） | `questionDetail.digestDraft` | DigestDraft の title / content 等 | ダイジェストドラフト生成 |

論点レポートは、上記のとおり **DebateAnalysis の `formattedReport` のみ**を読み込む設定になっており、このページ用に AI が論点だけを元に独自に HTML を生成しています。
